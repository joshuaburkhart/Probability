---
title: "midterm"
author: "Joshua Burkhart"
output: 
  pdf_document: 
    latex_engine: xelatex
---
```{r global_options, echo=FALSE, include=FALSE, error=FALSE}
knitr::opts_chunk$set(fig.path = "Figs/",
                      message = FALSE,
                      warning = FALSE,
                      include = TRUE,
                      echo = TRUE,
                      error = TRUE,
                      fig.width = 11,
                      comment = NA)
```

Midterm: Simple Linear Regression
=================================

Overview
--------
```{r}
library(plyr) #this must be loaded before dplyr 
library(dplyr)
library(ggplot2)
library(broom)
```

```{r}
library(Lahman)
?Lahman
```

```{r}
Teams <- Lahman::Teams
Salaries <- Lahman::Salaries
```

HLO Lahman
----------

```{r}
str(Teams)
str(Salaries)
glimpse(Teams)
glimpse(Salaries)
head(Teams)
head(Salaries)
tail(Teams)
tail(Salaries)
names(Teams)
names(Salaries)
ncol(Teams)
ncol(Salaries)
length(Teams)
length(Salaries)
head(rownames(Teams))
head(rownames(Salaries))
dim(Teams)
dim(Salaries)
nrow(Teams)
nrow(Salaries)
summary(Teams)
summary(Salaries)
?Teams
?Salaries
```

Are they data.frames, matrices, vectors, lists?

> data.frames  

What is the unit of analysis in the dataset?

> Teams: Yearly statistics and standings for teams.  
  Salaries: Player salary data.  

How many variables/columns?

> Teams: 48  
  Salaries: 5  

How many rows/observations?

> Teams: 2775  
  Salaries: 24758  

Find the variables for games won, team, year, and salary.

> W: Wins  
  teamID: Team; a factor  
  yearID: Year  
  salary: Salary  

Which variables are continuous?

> In theory, salary could be continuous but in practice, salary looks like it's rounded to the nearest thousand.  

Which variables are discrete?

> W  
  teamID  
  yearID  
  salary  

Which variables are categorical?

> teamID  

How many levels do they have?

> 149  

What about missing data for any variables?

```{r}
unique(is.na(Teams))
unique(is.na(Salaries))
```

> Teams: Missing data in several columns  
  Salaries: No missing data reported  
  
Data wrangling in dplyr
-----------------------

Create a new dataset that includes total yearly payroll for each team in the Salaries dataframe.

```{r}
typ <- Salaries %>% group_by(yearID,teamID) %>% summarise(payroll = sum(salary))
head(typ)
```

Add this payroll column to the Teams dataframe.

```{r}
teams_pay <- inner_join(Teams,typ,c("yearID","teamID"))
head(teams_pay)
```

We'll focus on the years 2000 - 2014. Use dplyr to filter() the dataset you created with the Teams data plus the payroll column for just those years.

```{r}
recent_tpay <- filter(teams_pay, yearID >= 2000, yearID <= 2014)
```

Gift
```{r}
bat_stats <- battingStats(data = Lahman::Batting, idvars = c("playerID", "yearID", "stint", "teamID", "lgID"), cbind = TRUE)
```

Write a dplyr expression to create a new dataframe that contains means for each of these three new variables for each team and year from 2000 - 2014 (rather than for each player). 

```{r}
bat_avgs <- bat_stats %>% filter(yearID >= 2000, yearID <= 2014) %>% group_by(yearID,teamID) %>% summarise(ob_perc = mean(OBP,na.rm = TRUE),slug_perc = mean(SlugPct,na.rm = TRUE),ops = mean(OPS,na.rm = TRUE))
head(bat_avgs)
```

Adds these new batting statistic columns to your current dataframe

```{r}
# warning seems ok based on http://goo.gl/9QH3fo
teams_bat <- inner_join(bat_avgs,recent_tpay,c("yearID","teamID"))
head(teams_bat)
```

Univariate EDA (+ more wrangling)
---------------------------------

```{r}
teams_bat %>%
  group_by(teamID) %>%
  tally() %>% arrange(n) %>%
  print(n = 33) 
```

How many teams are there?

> 33  

Which teams have data for the least number of seasons?

> MIA, ANA, and MON 

Which have the most seasons?

> ARI,ATL,BAL,BOS,CHA,CHN,CIN,CLE,COL,  
  DET,HOU,KCA,LAN,MIL,MIN,NYA,NYN,OAK,  
  PHI,PIT,SDN,SEA,SFN,SLN,TBA,TEX,TOR all have 15  

```{r}
teams_bat <- teams_bat %>%
  filter(!(teamID %in% c("ANA", "MIA", "MON"))) # you should understand what this does
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(G) %>%
  summarise_each(funs(min,max,mean,median))
```

Is there a lot of variability in number of games played per season across teams?

> No  

What is the range of games played by teams per season?

> 2 (163 - 161)  

Number of games won

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(W) %>%
  summarise_each(funs(min,max)) %>% head()
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(W) %>%
  summarise_each(funs(min,max)) %>% ggplot() +
  geom_smooth(aes(x=yearID,y=min),color="orange") +
  geom_smooth(aes(x=yearID,y=max),color="purple")
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(W) %>%
  summarise_each(funs(min,max)) %>% ggplot() +
  geom_histogram(aes(min,y=..density..),color="orange") +
  geom_density(aes(min),color="orange") +
  geom_histogram(aes(max,y=..density..),color="purple") +
  geom_density(aes(max),color="purple")
```

Mean on-base percentage

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc) %>%
  summarise_each(funs(mean)) %>% head()
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_smooth(aes(x=yearID,y=ob_perc),color="green")
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_histogram(aes(ob_perc,y=..density..),color="green",binwidth=0.008) +
  geom_density(aes(ob_perc),color="green")
```

Mean slugging percentage

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(slug_perc) %>%
  summarise_each(funs(mean)) %>% head()
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_smooth(aes(x=yearID,y=slug_perc),color="red")
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_histogram(aes(slug_perc,y=..density..),color="red",binwidth=0.008) +
  geom_density(aes(slug_perc),color="red")
```

Mean on-base percentage + slugging

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% head()
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_smooth(aes(x=yearID,y=ob_perc),color="green") +
  geom_smooth(aes(x=yearID,y=slug_perc),color="red") +
  geom_smooth(aes(x=yearID,y=(slug_perc - ob_perc)),color="blue")
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_histogram(aes(ob_perc,y=..density..),color="green",binwidth=0.008) +
  geom_density(aes(ob_perc),color="green") +
  geom_histogram(aes(slug_perc,y=..density..),color="red",binwidth=0.008) +
  geom_density(aes(slug_perc),color="red")
```

Bivariate EDA (+ even more wrangling)
-------------------------------------

Use ggplot2 to create a scatterplot showing payroll (x-axis) and wins (y-axis) across all time periods and teams.

```{r}
teams_pay %>% select(payroll,W) %>% ggplot() +
  geom_point(aes(x=payroll/1000,y=W)) + geom_smooth(aes(x=payroll/1000,y=W),method="lm")
```

One variable we are not accounting for in this scatterplot is year. It is possible that payrolls increase from season to season. Check this out using the same ggplot code you just used above, but make this plot with year on the x-axis and payroll/1000 on the y-axis.

```{r}
teams_pay %>% select(yearID,payroll) %>% ggplot() +
  geom_point(aes(x=yearID,y=payroll/1000)) + geom_smooth(aes(x=yearID,y=payroll/1000),method="lm")
```

A scatterplot may not be the best way to look at this pattern, since year is a discrete variable. So also try making boxplots stratified by yearID.

```{r}
teams_pay %>% select(yearID,payroll) %>% ggplot() +
  geom_boxplot(aes(x=factor(yearID),y=payroll/1000))
```

Create new variables for the average payroll and the standard deviation of payrolls each year across teams and add them to your dataframe.

```{r}
teams_bat <- teams_bat %>% group_by(yearID) %>% 
  mutate(avg_pay = mean(payroll),
         std_pay = sd(payroll))
```

Add another variable to your dataset that is the z-score for each team for each year.

```{r}
teams_bat <- teams_bat %>% group_by(yearID) %>% 
  mutate(z_pay = (payroll - avg_pay) / std_pay)
```

Make a scatterplot in ggplot with year on the x-axis and payroll z-scores on the y-axis and two geoms: geom_point() and geom_smooth(method = "lm").

```{r}
teams_bat %>% select(yearID,z_pay) %>% ggplot() +     geom_point(aes(x=yearID,y=z_pay)) + geom_smooth(aes(x=yearID,y=z_pay),method="lm")
```

What do you see? 

> I see a scatter plot centered about y = 0 with a
z_pay spread that looks similar across year.

How is this plot different from the previous one with payroll/1000 on the y-axis (from #12)?

> The other plot showed payroll/1000 increasing
with year. This plot shows z_pay steady across year
(which, of course, makes perfect sense as it's 
relative to each year's mean payroll)

Make a new scatterplot (minus geom_smooth) in ggplot with year on the x-axis and payroll z-scores on the y-axis. This time, add an additional aesthetic to colour the points in the scatterplot with a different color for each teamID, and an additional geom called geom_line().

```{r}
teams_bat %>% select(yearID,z_pay,teamID) %>% ggplot() +     geom_point(aes(x=yearID,y=z_pay)) + geom_line(aes(x=yearID,y=z_pay,color=factor(teamID)))
```

What do you see? 

> I see points indicating team payroll by year 
connected by colored lines indicating teamID.

What is not surprising here?

> Teams tend to move only slightly (relative 
to each other) each year. Teams at the top 
tend to stay toward the top, teams on the bottom tend
to stay toward the bottom.

Use dplyr to create a new dataset ... that includes two new variables: average payroll z-score and average number of wins. Both averages should be calculated for each team across all seasons.

```{r}
teams_anl <- teams_bat %>%
  group_by(teamID) %>%
  summarise(avg_z_pay = mean(z_pay,na.rm=TRUE),
  avg_w_cnt = mean(W,na.rm=TRUE))
```

What will be the mean and standard deviation of this new variable across the 30 teams?

> mean: This will be the mean distance of the annual payroll from the annual mean payroll across teams.  

> sd: This will be the spread of the distance
of the annual payroll from the annual mean
payroll across teams.  

That is, is your new average payroll z-score also a z-score?

> yes  

Are you surprised?

> Not too surprised.

Why or why not?

> If I think about a z-score has having a unit, z-scoreness?, it makes sense to me that an 
average of z-scores keeps its z-scoreness.  

Now create a scatterplot to see the association between average payroll z-scores (x-axis) and average number of wins (y-axis).

```{r}
teams_anl %>% ggplot() +
  geom_point(aes(x=avg_z_pay,y=avg_w_cnt)) +
  geom_smooth(aes(x=avg_z_pay,y=avg_w_cnt),method="lm")
```

```{r}
teams_anl %>% lm(avg_w_cnt ~ avg_z_pay,.) %>% summary()
```

Use both the plot and the correlation statistics to evaluate (in words) the form (does the relationship look linear?) and strength of the association between these two variables.

> The form looks as if it can be approximated by a linear
model. The correlation is slight (Adj. R-squared = 0.4587)
but significant (p-value: 2.375e-05).  

Would you be comfortable using a linear model to predict the mean number of wins in a given season given their average relative payroll for that season?

> Given such a low R-squared, I'd be hesitant to
predict the exact number of wins, though with such a
low p-value, I might be comfortable making more general
predictions, like predicting the mean number of wins is
within some range etc.

Regression model
----------------

Build a simple linear regression model predicting mean wins from mean payroll z-scores across seasons.

```{r}
teams_anl_lm <- teams_anl %>% lm(avg_w_cnt ~ avg_z_pay,.)
teams_anl_lm %>% anova()
teams_anl_lm %>% summary()
teams_anl_lm %>% glance()
```

What are the total, model, and residual sums of squares for this simple linear regression?

> model: 506.05
  residual: 554.13

What percent of the variation in mean wins is "explained" by variation in mean payroll z-scores?

> 45.87% (using Adj. R-squared)


Wrap-up
-------


  
