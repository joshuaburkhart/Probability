---
title: "midterm"
author: "Joshua Burkhart"
output: 
  pdf_document: 
    latex_engine: xelatex
---
```{r global_options, echo=FALSE, include=FALSE, error=FALSE}
knitr::opts_chunk$set(fig.path = "Figs/",
                      message = FALSE,
                      warning = FALSE,
                      include = TRUE,
                      echo = TRUE,
                      error = TRUE,
                      fig.width = 11,
                      comment = NA)
```

Midterm: Simple Linear Regression
=================================

Overview
--------
```{r}
library(plyr) #this must be loaded before dplyr 
library(dplyr)
library(ggplot2)
library(broom)
```

```{r}
library(Lahman)
?Lahman
```

```{r}
Teams <- Lahman::Teams
Salaries <- Lahman::Salaries
```

HLO Lahman
----------

```{r}
str(Teams)
str(Salaries)
glimpse(Teams)
glimpse(Salaries)
head(Teams)
head(Salaries)
tail(Teams)
tail(Salaries)
names(Teams)
names(Salaries)
ncol(Teams)
ncol(Salaries)
length(Teams)
length(Salaries)
head(rownames(Teams))
head(rownames(Salaries))
dim(Teams)
dim(Salaries)
nrow(Teams)
nrow(Salaries)
summary(Teams)
summary(Salaries)
?Teams
?Salaries
```

Are they data.frames, matrices, vectors, lists?

> data.frames  

What is the unit of analysis in the dataset?

> Teams: Yearly statistics and standings for teams.  
  Salaries: Player salary data.  

How many variables/columns?

> Teams: 48  
  Salaries: 5  

How many rows/observations?

> Teams: 2775  
  Salaries: 24758  

Find the variables for games won, team, year, and salary.

> W: Wins  
  teamID: Team; a factor  
  yearID: Year  
  salary: Salary  

Which variables are continuous?

> In theory, salary could be continuous but in practice, salary looks like it's rounded to the nearest thousand.  

Which variables are discrete?

> W  
  teamID  
  yearID  
  salary  

Which variables are categorical?

> teamID  

How many levels do they have?

> 149  

What about missing data for any variables?

```{r}
unique(is.na(Teams))
unique(is.na(Salaries))
```

> Teams: Missing data in several columns  
  Salaries: No missing data reported  
  
Data wrangling in dplyr
-----------------------

Create a new dataset that includes total yearly payroll for each team in the Salaries dataframe.

```{r}
typ <- Salaries %>% group_by(yearID,teamID) %>% summarise(payroll = sum(salary))
head(typ)
```

Add this payroll column to the Teams dataframe.

```{r}
teams_pay <- inner_join(Teams,typ,c("yearID","teamID"))
head(teams_pay)
```

We'll focus on the years 2000 - 2014. Use dplyr to filter() the dataset you created with the Teams data plus the payroll column for just those years.

```{r}
recent_tpay <- filter(teams_pay, yearID >= 2000, yearID <= 2014)
```

Gift
```{r}
bat_stats <- battingStats(data = Lahman::Batting, idvars = c("playerID", "yearID", "stint", "teamID", "lgID"), cbind = TRUE)
```

Write a dplyr expression to create a new dataframe that contains means for each of these three new variables for each team and year from 2000 - 2014 (rather than for each player). 

```{r}
bat_avgs <- bat_stats %>% filter(yearID >= 2000, yearID <= 2014) %>% group_by(yearID,teamID) %>% summarise(ob_perc = mean(OBP,na.rm = TRUE),slug_perc = mean(SlugPct,na.rm = TRUE),ops = mean(OPS,na.rm = TRUE))
head(bat_avgs)
```

Adds these new batting statistic columns to your current dataframe

```{r}
# warning seems ok based on http://goo.gl/9QH3fo
teams_bat <- inner_join(bat_avgs,recent_tpay,c("yearID","teamID"))
head(teams_bat)
```

Univariate EDA (+ more wrangling)
---------------------------------

```{r}
teams_bat %>%
  group_by(teamID) %>%
  tally() %>% arrange(n) %>%
  print(n = 33) 
```

How many teams are there?

> 33  

Which teams have data for the least number of seasons?

> MIA, ANA, and MON 

Which have the most seasons?

> ARI,ATL,BAL,BOS,CHA,CHN,CIN,CLE,COL,  
  DET,HOU,KCA,LAN,MIL,MIN,NYA,NYN,OAK,  
  PHI,PIT,SDN,SEA,SFN,SLN,TBA,TEX,TOR all have 15  

```{r}
teams_bat <- teams_bat %>%
  filter(!(teamID %in% c("ANA", "MIA", "MON"))) # you should understand what this does
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(G) %>%
  summarise_each(funs(min,max,mean,median))
```

Is there a lot of variability in number of games played per season across teams?

> No  

What is the range of games played by teams per season?

> 2 (163 - 161)

Number of games won

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(W) %>%
  summarise_each(funs(min,max)) %>% head()
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(W) %>%
  summarise_each(funs(min,max)) %>% ggplot() +
  geom_smooth(aes(x=yearID,y=min),color="orange") +
  geom_smooth(aes(x=yearID,y=max),color="purple")
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(W) %>%
  summarise_each(funs(min,max)) %>% ggplot() +
  geom_histogram(aes(min,y=..density..),color="orange") +
  geom_density(aes(min),color="orange") +
  geom_histogram(aes(max,y=..density..),color="purple") +
  geom_density(aes(max),color="purple")
```

Mean on-base percentage

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc) %>%
  summarise_each(funs(mean)) %>% head()
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_smooth(aes(x=yearID,y=ob_perc),color="green")
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_histogram(aes(ob_perc,y=..density..),color="green",binwidth=0.008) +
  geom_density(aes(ob_perc),color="green")
```

Mean slugging percentage

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(slug_perc) %>%
  summarise_each(funs(mean)) %>% head()
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_smooth(aes(x=yearID,y=slug_perc),color="red")
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_histogram(aes(slug_perc,y=..density..),color="red",binwidth=0.008) +
  geom_density(aes(slug_perc),color="red")
```

Mean on-base percentage + slugging

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% head()
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_smooth(aes(x=yearID,y=ob_perc),color="green") +
  geom_smooth(aes(x=yearID,y=slug_perc),color="red") +
  geom_smooth(aes(x=yearID,y=(slug_perc - ob_perc)),color="blue")
```

```{r}
teams_bat %>%
  group_by(yearID) %>%
  select(ob_perc,slug_perc) %>%
  summarise_each(funs(mean)) %>% ggplot() +
  geom_histogram(aes(ob_perc,y=..density..),color="green",binwidth=0.008) +
  geom_density(aes(ob_perc),color="green") +
  geom_histogram(aes(slug_perc,y=..density..),color="red",binwidth=0.008) +
  geom_density(aes(slug_perc),color="red")
```

Bivariate EDA (+ even more wrangling)
-------------------------------------

Regression model
----------------

Wrap-up
-------


  
